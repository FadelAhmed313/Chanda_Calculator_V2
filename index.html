<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chanda Calculator</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Include html2canvas from CDN -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    .footer {
      position: relative;
      left: 0;
      bottom: 0;
      width: 100%;
      background-color: #343a40;
      color: white;
      text-align: center;
      margin-top: auto;
    }
    
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 60px;
    }
    
    .page-section {
      display: none;
    }
    
    .page-section.active {
      display: block;
    }
    
    .offline-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #ffc107;
      color: #212529;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
    }
    
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
    }
    
    .card-header {
      background-color: #343a40;
      color: white;
      border-radius: 10px 10px 0 0 !important;
    }
    
    .btn-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      font-weight: bold;
    }
    
    .nav-link.active {
      color: #ffc107 !important;
      font-weight: bold;
    }
    
    .section-title {
      color: #343a40;
      border-bottom: 2px solid #ffc107;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .info-icon {
      color: #ffc107;
      margin-left: 5px;
      cursor: pointer;
    }
    
    .notes-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ced4da;
      font-size: 14px;
      resize: vertical;
    }
    
    .aims-title {
      color: #28a745;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      display: block;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .success-message {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1002;
      display: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .total-row {
      color: #28a745;
      font-weight: bold;
    }
    
    .aims-display {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #ffc107;
    }
    
    .date-range-display {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 5px;
      font-weight: bold;
    }
    
    .capture-container {
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
    }
    
    .btn-info {
      background-color: #17a2b8;
      border-color: #17a2b8;
    }
    
    #imageDownload {
      display: none;
    }
    
    .image-preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    
    .image-preview-content {
      background-color: white;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .preview-image {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 20px 0;
    }
    
    .save-instructions {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
      text-align: left;
    }
    
    .instruction-step {
      margin: 10px 0;
      padding-left: 25px;
      position: relative;
    }
    
    .instruction-step:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .image-preview-content {
        margin: 10px auto;
        padding: 15px;
      }
    }
    
    /* Print styles for better image printing */
    @media print {
      body * {
        visibility: hidden;
      }
      .printable-image, .printable-image * {
        visibility: visible;
      }
      .printable-image {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .no-print {
        display: none !important;
      }
    }
    
    .printable-image {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: 0 auto;
      font-family: Arial, sans-serif;
    }
    
    .print-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    .print-table th {
      background-color: #343a40;
      color: white;
      padding: 12px;
      text-align: left;
    }
    
    .print-table td {
      padding: 10px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .print-total {
      font-weight: bold;
      color: #28a745;
      font-size: 1.3rem;
      text-align: right;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 2px solid #28a745;
    }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div id="offlineIndicator" class="offline-indicator">
    <span>Offline Mode</span>
  </div>
  
  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner-border text-warning" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
  
  <!-- Success Message -->
  <div id="successMessage" class="success-message">
    Settings saved successfully!
  </div>
  
  <!-- Image Success Message -->
  <div id="imageSuccessMessage" class="success-message" style="background-color: #007bff;">
    Image generated successfully! Check the preview.
  </div>
  
  <!-- Image Preview Modal -->
  <div id="imagePreviewModal" class="image-preview-modal">
    <div class="image-preview-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">ðŸ“‹ Chanda Breakdown</h3>
        <button onclick="closeImagePreview()" class="btn btn-danger btn-sm">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
      
      <div id="imagePreviewContainer" class="printable-image">
        <!-- Image will be generated here -->
      </div>
      
      <div class="save-instructions">
        <h5><i class="fas fa-download"></i> How to Save & Share:</h5>
        
        <div class="instruction-step">
          <strong>Method 1: Take Screenshot (Easiest)</strong><br>
          Press <kbd>Power</kbd> + <kbd>Volume Down</kbd> buttons together
        </div>
        
        <div class="instruction-step">
          <strong>Method 2: Save Image</strong><br>
          Long press the image above â†’ "Save image" or "Download image"
        </div>
        
        <div class="instruction-step">
          <strong>Method 3: Print to PDF</strong><br>
          Click "Print" button below â†’ Choose "Save as PDF"
        </div>
        
        <div class="instruction-step">
          <strong>Method 4: Share Directly</strong><br>
          Click "Share" button below (if supported by your device)
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-4 mb-2">
          <button onclick="printImage()" class="btn btn-warning btn-block">
            <i class="fas fa-print"></i> Print
          </button>
        </div>
        <div class="col-md-4 mb-2">
          <button onclick="downloadImage()" class="btn btn-success btn-block">
            <i class="fas fa-download"></i> Download
          </button>
        </div>
        <div class="col-md-4 mb-2">
          <button onclick="shareImage()" class="btn btn-info btn-block">
            <i class="fas fa-share-alt"></i> Share
          </button>
        </div>
      </div>
      
      <div class="mt-3">
        <small class="text-muted">
          <i class="fas fa-lightbulb"></i> Tip: The image is also saved to your browser cache. You can find it in your downloads folder.
        </small>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#"><strong>Chanda Calculator</strong></a>
    <button id="navbar" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#home">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#privacy">Privacy and Security</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#rate">%Rate</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#aims">Setting</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Home Page -->
    <div id="home" class="page-section">
      <h2 class="section-title">Chanda Calculator</h2>
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Member Information</h5>
        </div>
        <div class="card-body">
          <form id="salaryForm">
            <div class="form-group">
              <label for="salary"><strong>Monthly Income (Rs):</strong></label>
              <input type="number" id="salary" class="form-control" min="0" placeholder="Enter your monthly income" required>
              <div id="salaryError" class="error-message">Please set your Member Group in Settings first</div>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">Chanda Breakdown</h5>
        </div>
        <div class="card-body">
          <div id="aimsDisplay" class="aims-display" style="display: none;">
            <span class="aims-title" id="aimsDisplayText"></span>
            <div id="dateRangeDisplay" class="date-range-display"></div>
          </div>
          
          <table id="myTable" class="table mt-4">
            <thead>
              <tr>
                <th>Funds</th>
                <th>Amount (Rs)</th>
                <th style="width:30%">Roundoff</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td id="aamString">Aam</td>
                <td id="aamValue">-</td>
                <td><input type="number" id="inputAam" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Jalsa</td>
                <td id="jalsaValue">-</td>
                <td><input type="number" id="inputJalsa" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td id="groupString">Khuddam</td>
                <td id="khuddamValue">-</td>
                <td><input type="number" id="inputKhuddam" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Ijtema</td>
                <td id="ijtemaValue">-</td>
                <td><input type="number" id="inputIjtema" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Tehrik-e-Jadid</td>
                <td id="tehrikValue">-</td>
                <td><input type="number" id="inputTehrik" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Waqf-e-Jadid</td>
                <td id="waqfValue">-</td>
                <td><input type="number" id="inputWaqf" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr class="total-row">
                <td style="font-weight: bold;">Total</td>
                <td style="font-weight: bold;" id="totalValue">-</td>
                <td style="font-weight: bold;" id="additionalFund">
                  <button id="addRowBtn" type="button" class="btn btn-warning btn-sm">
                    Add Fund
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          
          <div class="form-group mt-4">
            <label for="notesTextarea"><strong>Notes/Remarks:</strong></label>
            <textarea id="notesTextarea" class="notes-textarea form-control" placeholder="Add any notes or remarks here..."></textarea>
          </div>

          <div class="capture-container">
            <div class="row">
              <div class="col-md-6 mb-2">
                <button id="generateImageBtn" class="btn btn-success btn-lg btn-block">
                  <i class="fas fa-camera"></i> Generate Image
                </button>
              </div>
              <div class="col-md-6 mb-2">
                <button id="quickSaveBtn" class="btn btn-info btn-lg btn-block">
                  <i class="fas fa-bolt"></i> Quick Save
                </button>
              </div>
            </div>
            <div class="text-center mt-3">
              <small class="text-muted">
                <i class="fas fa-info-circle"></i> "Generate Image" creates a clean printable version. "Quick Save" downloads directly.
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Other pages remain exactly the same -->
    <!-- ... (About, Privacy, Rate, AIMS pages unchanged) ... -->

  </div>

  <!-- Hidden link for download -->
  <a id="imageDownload" download="Chanda_Breakdown.png"></a>

  <!-- Include Bootstrap JS and jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

  <script>
    // Store the latest generated image data URL
    let latestImageDataUrl = null;
    
    // Initialize the application
    document.addEventListener("DOMContentLoaded", function() {
      initApp();
    });

    function initApp() {
      loadSavedData();
      initNavigation();
      initEventListeners();
      initYearDropdowns();
      checkMemberGroup();
      updateAimsDisplay();
    }

    // Navigation functions remain the same
    function initNavigation() {
      const pages = ["home", "about", "privacy", "rate", "aims"];
      let defaultPage = "home";

      if (!localStorage.getItem("memberGroup")) {
        defaultPage = "aims";
      }

      function showPage(page) {
        pages.forEach((p) => {
          const pageElement = document.getElementById(p);
          if (pageElement) {
            pageElement.classList.remove("active");
          }
        });
        
        const activePage = document.getElementById(page);
        if (activePage) {
          activePage.classList.add("active");
        }
        
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${page}`) {
            link.classList.add('active');
          }
        });
        
        window.location.hash = page;
        
        if (page === "home") {
          checkMemberGroupForHome();
        }
      }

      const initialPage = window.location.hash ? window.location.hash.substr(1) : defaultPage;
      if (pages.includes(initialPage)) {
        showPage(initialPage);
      } else {
        showPage(defaultPage);
      }

      window.addEventListener("hashchange", function() {
        const currentPage = window.location.hash.substr(1);
        if (pages.includes(currentPage)) {
          showPage(currentPage);
          const navbarToggler = document.getElementById("navbar");
          if (navbarToggler && !navbarToggler.classList.contains('collapsed')) {
            navbarToggler.click();
          }
        }
      });
    }

    function initYearDropdowns() {
      const currentYear = new Date().getFullYear();
      const fromYearSelect = document.getElementById("fromYear");
      const toYearSelect = document.getElementById("toYear");
      
      if (!fromYearSelect || !toYearSelect) return;
      
      fromYearSelect.innerHTML = '';
      toYearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= currentYear - 1; year--) {
        const option1 = document.createElement("option");
        option1.value = year;
        option1.textContent = year;
        fromYearSelect.appendChild(option1);
        
        const option2 = document.createElement("option");
        option2.value = year;
        option2.textContent = year;
        toYearSelect.appendChild(option2);
      }
      
      fromYearSelect.value = currentYear;
      toYearSelect.value = currentYear;
    }

    function checkMemberGroup() {
      if (!localStorage.getItem("memberGroup")) {
        showPage("aims");
      }
    }

    function checkMemberGroupForHome() {
      const savedGroup = localStorage.getItem("memberGroup");
      const salaryInput = document.getElementById("salary");
      const salaryError = document.getElementById("salaryError");
      
      if (!salaryInput || !salaryError) return;
      
      if (!savedGroup) {
        salaryInput.disabled = true;
        salaryInput.placeholder = "Please set Member Group in Settings first";
        salaryError.style.display = "block";
      } else {
        salaryInput.disabled = false;
        salaryInput.placeholder = "Enter your monthly income";
        salaryError.style.display = "none";
      }
    }

    function showPage(page) {
      const pages = ["home", "about", "privacy", "rate", "aims"];
      
      pages.forEach((p) => {
        const pageElement = document.getElementById(p);
        if (pageElement) {
          pageElement.classList.remove("active");
        }
      });
      
      const activePage = document.getElementById(page);
      if (activePage) {
        activePage.classList.add("active");
      }
      
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${page}`) {
          link.classList.add('active');
        }
      });
    }

    function loadSavedData() {
      // Load all saved data (same as before)
      if (localStorage.getItem("AIMSnumber")) {
        document.getElementById("AIMSnumber").value = localStorage.getItem("AIMSnumber");
      }
      
      if (localStorage.getItem("chandaNotes")) {
        document.getElementById("notesTextarea").value = localStorage.getItem("chandaNotes");
      }
      
      if (localStorage.getItem("isMusis") === "true") {
        document.getElementById("musisCheckbox").checked = true;
      }
      
      if (localStorage.getItem("memberGroup")) {
        document.getElementById("memberGroup").value = localStorage.getItem("memberGroup");
      }
      
      if (localStorage.getItem("fromMonth")) {
        document.getElementById("fromMonth").value = localStorage.getItem("fromMonth");
      }
      
      if (localStorage.getItem("fromYear")) {
        document.getElementById("fromYear").value = localStorage.getItem("fromYear");
      }
      
      if (localStorage.getItem("toMonth")) {
        document.getElementById("toMonth").value = localStorage.getItem("toMonth");
      }
      
      if (localStorage.getItem("toYear")) {
        document.getElementById("toYear").value = localStorage.getItem("toYear");
      }
    }

    function initEventListeners() {
      // Existing event listeners
      const memberGroupSelect = document.getElementById("memberGroup");
      if (memberGroupSelect) {
        memberGroupSelect.addEventListener("change", function() {
          console.log("Member group changed to:", this.value);
        });
      }
      
      const addRowBtn = document.getElementById("addRowBtn");
      if (addRowBtn) {
        addRowBtn.addEventListener("click", addRow);
      }
      
      const settingsForm = document.getElementById("settingsForm");
      if (settingsForm) {
        settingsForm.addEventListener("submit", saveSettings);
      }
      
      const salaryInput = document.getElementById("salary");
      if (salaryInput) {
        salaryInput.addEventListener("input", calculate);
      }
      
      const tableInputs = document.querySelectorAll("#inputAam, #inputJalsa, #inputKhuddam, #inputIjtema, #inputTehrik, #inputWaqf");
      tableInputs.forEach(input => {
        input.addEventListener("input", calculate);
      });
      
      const notesTextarea = document.getElementById("notesTextarea");
      if (notesTextarea) {
        notesTextarea.addEventListener("blur", saveNotes);
      }
      
      // NEW: Generate Image button
      const generateImageBtn = document.getElementById("generateImageBtn");
      if (generateImageBtn) {
        generateImageBtn.addEventListener("click", generateAndPreviewImage);
      }
      
      // NEW: Quick Save button
      const quickSaveBtn = document.getElementById("quickSaveBtn");
      if (quickSaveBtn) {
        quickSaveBtn.addEventListener("click", quickSaveImage);
      }
    }

    // NEW: Generate and preview image
    function generateAndPreviewImage() {
      document.getElementById('loadingSpinner').style.display = 'block';
      
      // Create a clean printable version
      const printableDiv = document.createElement('div');
      printableDiv.className = 'printable-image';
      
      const memberGroup = localStorage.getItem("memberGroup") || "-";
      const aimsNumber = localStorage.getItem("AIMSnumber");
      const fromMonth = localStorage.getItem("fromMonth");
      const fromYear = localStorage.getItem("fromYear");
      const toMonth = localStorage.getItem("toMonth");
      const toYear = localStorage.getItem("toYear");
      const notes = document.getElementById("notesTextarea").value;
      
      // Build the printable content
      let content = `<h2 style="text-align:center; color:#343a40; border-bottom:2px solid #ffc107; padding-bottom:10px; margin-bottom:20px;">
        Chanda ${memberGroup} Breakdown
      </h2>`;
      
      if (aimsNumber) {
        content += `<div style="background-color:#f8f9fa; padding:10px 15px; border-radius:5px; margin-bottom:15px; border-left:4px solid #ffc107;">
          <span style="color:#28a745; font-size:1.2rem; font-weight:bold; display:block;">AIMS: ${aimsNumber}</span>`;
        
        if (fromMonth && fromYear) {
          if (toMonth && toYear) {
            if (fromMonth === toMonth && fromYear === toYear) {
              content += `<div style="font-size:0.9rem; color:#6c757d; margin-top:5px; font-weight:bold;">For: ${fromMonth} ${fromYear}</div>`;
            } else {
              content += `<div style="font-size:0.9rem; color:#6c757d; margin-top:5px; font-weight:bold;">From: ${fromMonth} ${fromYear} to ${toMonth} ${toYear}</div>`;
            }
          } else {
            content += `<div style="font-size:0.9rem; color:#6c757d; margin-top:5px; font-weight:bold;">For: ${fromMonth} ${fromYear}</div>`;
          }
        } else {
          const currentDate = new Date();
          const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
          const currentYear = currentDate.getFullYear();
          content += `<div style="font-size:0.9rem; color:#6c757d; margin-top:5px; font-weight:bold;">For: ${currentMonth} ${currentYear}</div>`;
        }
        content += '</div>';
      }
      
      // Create table
      let tableHTML = '<table class="print-table"><thead><tr><th>Funds</th><th>Amount (Rs)</th></tr></thead><tbody>';
      let totalAmount = 0;
      
      // Get all funds from the table
      const tableRows = document.querySelectorAll("#myTable tbody tr");
      tableRows.forEach((row, index) => {
        if (index === tableRows.length - 1) return; // Skip total row
        
        let fundName = '';
        let amount = '';
        
        const firstCell = row.cells[0];
        const secondCell = row.cells[1];
        
        if (!firstCell || !secondCell) return;
        
        // Get fund name
        const fundInput = firstCell.querySelector('input');
        if (fundInput) {
          fundName = fundInput.value.trim();
        } else {
          fundName = firstCell.textContent.trim();
        }
        
        // Get amount
        const amountInput = secondCell.querySelector('input');
        if (amountInput) {
          amount = amountInput.value;
          if (amount && parseFloat(amount) > 0) {
            const amountValue = parseFloat(amount) || 0;
            totalAmount += amountValue;
            amount = amountValue.toLocaleString();
          }
        } else {
          amount = secondCell.textContent;
          if (amount !== '-') {
            const amountValue = parseFloat(amount.replace(/,/g, '')) || 0;
            totalAmount += amountValue;
            amount = amountValue.toLocaleString();
          }
        }
        
        // Include if valid
        if (fundName && amount && amount !== '-' && amount !== '0') {
          tableHTML += `<tr><td>${fundName}</td><td>${amount}</td></tr>`;
        }
      });
      
      tableHTML += '</tbody></table>';
      content += tableHTML;
      
      // Add total
      content += `<div class="print-total">Total : Rs ${totalAmount.toLocaleString()}</div>`;
      
      // Add notes if any
      if (notes.trim()) {
        content += `<div style="margin-top:30px; padding:15px; background-color:#f8f9fa; border-radius:5px;">
          <strong>Notes:</strong><br>
          <div style="margin-top:10px;">${notes.replace(/\n/g, '<br>')}</div>
        </div>`;
      }
      
      // Add footer
      content += `<div style="margin-top:30px; padding-top:15px; border-top:1px solid #dee2e6; text-align:center; color:#6c757d; font-size:0.8rem;">
        Generated by Chanda Calculator â€¢ ${new Date().toLocaleDateString()}
      </div>`;
      
      printableDiv.innerHTML = content;
      
      // Use html2canvas to capture the printable content
      html2canvas(printableDiv, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false,
        width: printableDiv.offsetWidth,
        height: printableDiv.offsetHeight
      }).then(canvas => {
        // Convert to data URL
        latestImageDataUrl = canvas.toDataURL('image/png');
        
        // Display in preview modal
        const previewContainer = document.getElementById('imagePreviewContainer');
        previewContainer.innerHTML = '';
        previewContainer.appendChild(canvas);
        
        // Show preview modal
        document.getElementById('imagePreviewModal').style.display = 'block';
        document.getElementById('loadingSpinner').style.display = 'none';
        showImageSuccessMessage();
        
        // Auto-download in background (for APK compatibility)
        setTimeout(() => {
          try {
            const downloadLink = document.getElementById("imageDownload");
            downloadLink.href = latestImageDataUrl;
            const memberGroup = localStorage.getItem("memberGroup") || "Breakdown";
            const dateStr = new Date().toISOString().slice(0,10);
            downloadLink.download = `Chanda_${memberGroup}_${dateStr}.png`;
            downloadLink.click();
          } catch (error) {
            console.log("Auto-download failed, user will need to save manually");
          }
        }, 1000);
        
      }).catch(error => {
        console.error('Error generating image:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        alert('Error generating image. Please try the Quick Save option instead.');
      });
    }

    // NEW: Quick save (direct download)
    function quickSaveImage() {
      document.getElementById('loadingSpinner').style.display = 'block';
      
      // Simple capture of the main content area
      const contentToCapture = document.querySelector('.card.mt-4 .card-body');
      
      if (!contentToCapture) {
        alert('No content to save. Please complete your calculation first.');
        document.getElementById('loadingSpinner').style.display = 'none';
        return;
      }
      
      html2canvas(contentToCapture, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const imageData = canvas.toDataURL('image/png');
        
        // Try multiple methods to save
        let saved = false;
        
        // Method 1: Direct download
        try {
          const downloadLink = document.getElementById("imageDownload");
          downloadLink.href = imageData;
          const memberGroup = localStorage.getItem("memberGroup") || "Breakdown";
          const dateStr = new Date().toISOString().slice(0,10);
          downloadLink.download = `Chanda_${memberGroup}_${dateStr}.png`;
          downloadLink.click();
          saved = true;
        } catch (e) {
          console.log("Method 1 failed:", e);
        }
        
        // Method 2: Open in new window
        if (!saved) {
          try {
            const newWindow = window.open();
            newWindow.document.write(`<img src="${imageData}" style="max-width:100%;">`);
            newWindow.document.close();
            saved = true;
          } catch (e) {
            console.log("Method 2 failed:", e);
          }
        }
        
        // Method 3: Show instructions
        if (!saved) {
          const modal = document.getElementById('imagePreviewModal');
          const container = document.getElementById('imagePreviewContainer');
          container.innerHTML = `<img src="${imageData}" style="max-width:100%; border-radius:5px;">`;
          modal.style.display = 'block';
        }
        
        document.getElementById('loadingSpinner').style.display = 'none';
        
        if (saved) {
          alert('Image saved successfully! Check your downloads folder.');
        }
        
      }).catch(error => {
        console.error('Error saving image:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        alert('Error saving image. Please take a screenshot instead.');
      });
    }

    // NEW: Download image function
    function downloadImage() {
      if (!latestImageDataUrl) {
        alert('Please generate an image first using the "Generate Image" button.');
        return;
      }
      
      try {
        const downloadLink = document.getElementById("imageDownload");
        downloadLink.href = latestImageDataUrl;
        const memberGroup = localStorage.getItem("memberGroup") || "Breakdown";
        const dateStr = new Date().toISOString().slice(0,10);
        downloadLink.download = `Chanda_${memberGroup}_${dateStr}.png`;
        downloadLink.click();
        alert('Image download started. Check your downloads folder.');
      } catch (error) {
        alert('Could not download automatically. Please:\n1. Long press the image\n2. Select "Save image"\n3. Or take a screenshot');
      }
    }

    // NEW: Print image function
    function printImage() {
      if (!latestImageDataUrl) {
        alert('Please generate an image first.');
        return;
      }
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Print Chanda Breakdown</title>
            <style>
              body { margin: 0; padding: 20px; }
              img { max-width: 100%; height: auto; }
              @media print {
                body { padding: 0; }
              }
            </style>
          </head>
          <body>
