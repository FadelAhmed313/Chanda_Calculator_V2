<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chanda Calculator</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .footer {
      position: relative;
      left: 0;
      bottom: 0;
      width: 100%;
      background-color: #343a40;
      color: white;
      text-align: center;
      margin-top: auto;
    }
    
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 60px;
    }
    
    .page-section {
      display: none;
    }
    
    .page-section.active {
      display: block;
    }
    
    .offline-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #ffc107;
      color: #212529;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
    }
    
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
    }
    
    .card-header {
      background-color: #343a40;
      color: white;
      border-radius: 10px 10px 0 0 !important;
    }
    
    .btn-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      font-weight: bold;
    }
    
    .nav-link.active {
      color: #ffc107 !important;
      font-weight: bold;
    }
    
    .section-title {
      color: #343a40;
      border-bottom: 2px solid #ffc107;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .info-icon {
      color: #ffc107;
      margin-left: 5px;
      cursor: pointer;
    }
    
    .notes-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ced4da;
      font-size: 14px;
      resize: vertical;
    }
    
    .aims-title {
      color: #28a745;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      display: block;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .success-message {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1002;
      display: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .total-row {
      color: #28a745;
      font-weight: bold;
    }
    
    .aims-display {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #ffc107;
    }
    
    .date-range-display {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 5px;
      font-weight: bold;
    }
    
    .capture-container {
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
    }
    
    .btn-info {
      background-color: #17a2b8;
      border-color: #17a2b8;
    }
    
    #imageDownload {
      display: none;
    }
    
    .instruction-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .instruction-content {
      background-color: white;
      max-width: 500px;
      margin: 50px auto;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .highlight-box {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    
    .step-number {
      display: inline-block;
      background-color: #28a745;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      margin-right: 10px;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .instruction-content {
        margin: 20px auto;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div id="offlineIndicator" class="offline-indicator">
    <span>Offline Mode</span>
  </div>
  
  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner-border text-warning" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
  
  <!-- Success Message -->
  <div id="successMessage" class="success-message">
    Settings saved successfully!
  </div>
  
  <!-- Instruction Modal -->
  <div id="instructionModal" class="instruction-modal">
    <div class="instruction-content">
      <h3 class="text-center mb-4">ðŸ“¸ How to Save Your Chanda Breakdown</h3>
      
      <div class="highlight-box">
        <h5><span class="step-number">1</span> Prepare the Screen</h5>
        <p>Make sure all your Chanda calculations are visible on the screen.</p>
      </div>
      
      <div class="highlight-box">
        <h5><span class="step-number">2</span> Take Screenshot</h5>
        <p><strong>For Android:</strong></p>
        <ul>
          <li>Press <strong>Power + Volume Down</strong> buttons together</li>
          <li>Or <strong>swipe down with three fingers</strong> (on some devices)</li>
        </ul>
        
        <p><strong>For iPhone:</strong></p>
        <ul>
          <li>Press <strong>Side button + Volume Up</strong></li>
          <li>For older iPhones: <strong>Home + Power</strong></li>
        </ul>
      </div>
      
      <div class="highlight-box">
        <h5><span class="step-number">3</span> Find & Share</h5>
        <ul>
          <li>Screenshot saves to your <strong>Photos/Gallery</strong></li>
          <li>Open the screenshot</li>
          <li>Tap <strong>Share</strong> button</li>
          <li>Choose app (WhatsApp, Email, etc.)</li>
        </ul>
      </div>
      
      <div class="text-center mt-4">
        <button onclick="closeInstructionModal()" class="btn btn-warning btn-lg" style="min-width: 150px;">
          Got It!
        </button>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#"><strong>Chanda Calculator</strong></a>
    <button id="navbar" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#home">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#privacy">Privacy and Security</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#rate">%Rate</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#aims">Setting</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Home Page -->
    <div id="home" class="page-section">
      <h2 class="section-title">Chanda Calculator</h2>
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Member Information</h5>
        </div>
        <div class="card-body">
          <form id="salaryForm">
            <div class="form-group">
              <label for="salary"><strong>Monthly Income (Rs):</strong></label>
              <input type="number" id="salary" class="form-control" min="0" placeholder="Enter your monthly income" required>
              <div id="salaryError" class="error-message">Please set your Member Group in Settings first</div>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">Chanda Breakdown</h5>
        </div>
        <div class="card-body">
          <div id="aimsDisplay" class="aims-display" style="display: none;">
            <span class="aims-title" id="aimsDisplayText"></span>
            <div id="dateRangeDisplay" class="date-range-display"></div>
          </div>
          
          <table id="myTable" class="table mt-4">
            <thead>
              <tr>
                <th>Funds</th>
                <th>Amount (Rs)</th>
                <th style="width:30%">Roundoff</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td id="aamString">Aam</td>
                <td id="aamValue">-</td>
                <td><input type="number" id="inputAam" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Jalsa</td>
                <td id="jalsaValue">-</td>
                <td><input type="number" id="inputJalsa" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td id="groupString">Khuddam</td>
                <td id="khuddamValue">-</td>
                <td><input type="number" id="inputKhuddam" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Ijtema</td>
                <td id="ijtemaValue">-</td>
                <td><input type="number" id="inputIjtema" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Tehrik-e-Jadid</td>
                <td id="tehrikValue">-</td>
                <td><input type="number" id="inputTehrik" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr>
                <td>Waqf-e-Jadid</td>
                <td id="waqfValue">-</td>
                <td><input type="number" id="inputWaqf" style="width:75%" min="0" value="0"></td>
              </tr>
              <tr class="total-row">
                <td style="font-weight: bold;">Total</td>
                <td style="font-weight: bold;" id="totalValue">-</td>
                <td style="font-weight: bold;" id="additionalFund">
                  <button id="addRowBtn" type="button" class="btn btn-warning btn-sm">
                    Add Fund
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          
          <div class="form-group mt-4">
            <label for="notesTextarea"><strong>Notes/Remarks:</strong></label>
            <textarea id="notesTextarea" class="notes-textarea form-control" placeholder="Add any notes or remarks here..."></textarea>
          </div>

          <div class="capture-container">
            <div class="row">
              <div class="col-md-6 mb-2">
                <button id="saveImageBtn" class="btn btn-success btn-lg btn-block">
                  <i class="fas fa-camera"></i> Save Screenshot
                </button>
              </div>
              <div class="col-md-6 mb-2">
                <button id="shareImageBtn" class="btn btn-info btn-lg btn-block">
                  <i class="fas fa-share-alt"></i> Share Screenshot
                </button>
              </div>
            </div>
            <div class="text-center mt-3">
              <small class="text-muted">
                <i class="fas fa-info-circle"></i> Both buttons will show you how to take and share a screenshot
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- About Page -->
    <div id="about" class="page-section">
      <h2 class="section-title">About</h2>
      <div class="card">
        <div class="card-body">
          <h4>About</h4>
          <p class="text-muted">The Chanda Calculator is a user-friendly web application designed by MKA Pailles to assist the Ahmadi community members in calculating their Chanda payments accurately. Whether you're a Khuddam, Lajna, or part of the Wassiyat scheme, this tool simplifies the process and ensures transparency.</p>
        </div>
      </div>
    </div>

    <!-- Privacy Page -->
    <div id="privacy" class="page-section">
      <div class="card">
        <div class="card-body">
          <h2 class="section-title">Privacy and Security</h2>
          <h4>Privacy and Security</h4>
          <ul style="list-style-type:square; color:#6c757d;">
            <li><span style="color:#6c757d;">The Chanda Calculator operates entirely on your local web browser. No data is stored or transmitted to external servers.</span></li>
            <li><span style="color:#6c757d;">Your privacy is our priority. Once you close the browser, all entered information is automatically cleared.</span></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Rate Page -->
    <div id="rate" class="page-section">
      <h2 class="section-title">% Rate</h2>
      <div class="card">
        <div class="card-body">
          <h4>% Rate</h4>
          <table class="table table-striped" style="margin-right: calc(1%); width: 99%;">
            <thead class="thead-dark">
              <tr>
                <th scope="col" style="width: 6.2232%;"><span style="font-size: 12px;">#</span></th>
                <th scope="col" style="width: 6.6023%;"><span style="font-size: 12px;">%</span></th>
                <th scope="col" style="width: 15.017%;"><span style="font-size: 12px;">Funds</span></th>
                <th scope="col" style="width: 72.1042%;"><span style="font-size: 12px;">Example</span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row" style="width: 6.2232%;"><span style="font-size: 12px;">1</span></th>
                <td style="width: 6.6023%;"><span style="font-size: 12px;">10%</span></td>
                <td style="width: 15.017%;"><span style="font-size: 12px;">Chanda Wassiyat Khuddam, Lajna and Ansar</span></td>
                <td style="width: 72.1042%;"><span style="font-size: 12px;">For a monthly salary of Rs10 000, Rs1000 should be paid <span style="color: rgb(226, 80, 65);">monthly</span></span></td>
              </tr>
              <tr>
                <th scope="row" style="width: 6.2232%;"><span style="font-size: 12px;">2</span></th>
                <td style="width: 6.6023%;"><span style="font-size: 12px;">6.25%<br></span></td>
                <td style="width: 15.017%;"><span style="font-size: 12px;">Chanda Aam Khuddam, Lajna and Ansar<br></span></td>
                <td style="width: 72.1042%;"><span style="font-size: 12px;">For a monthly salary of Rs10 000, Rs625 should be paid <span style="color: rgb(226, 80, 65);">monthly</span><br></span></td>
              </tr>
              <tr>
                <th scope="row" style="width: 6.2232%;"><span style="font-size: 12px;">3</span></th>
                <td style="width: 6.6023%;"><span style="font-size: 12px;">10%<br></span></td>
                <td style="width: 15.017%;"><span style="font-size: 12px;">Chanda Jalsa Khuddam, Lajna and Ansar<br></span></td>
                <td style="width: 72.1042%;"><span style="font-size: 12px;">For a monthly salary of Rs10 000, Rs1000 should be paid per <span style="color: rgb(44, 130, 201);">annum&nbsp;</span><strong>or&nbsp;</strong>Rs 83.33 per<strong>&nbsp;</strong><span style="color: rgb(226, 80, 65);">month</span><br></span></td>
              </tr>
              <tr>
                <th scope="row" style="width: 6.2232%;"><span style="font-size: 12px;">4</span></th>
                <td style="width: 6.6023%;"><span style="font-size: 12px;">1%<br></span></td>
                <td style="width: 15.017%;"><span style="font-size: 12px;">Chanda Khuddam, Lajna and Ansar<br></span></td>
                <td style="width: 72.1042%;"><span style="font-size: 12px;">For a monthly salary of Rs10 000, Rs100 should be paid&nbsp;<strong>&nbsp;</strong><span style="color: rgb(226, 80, 65);">monthly</span><br></span></td>
              </tr>
              <tr>
                <th scope="row" style="width: 6.2232%;"><span style="font-size: 12px;">5</span></th>
                <td style="width: 6.6023%;"><span style="font-size: 12px;">3%<br></span></td>
                <td style="width: 15.017%;"><span style="font-size: 12px;">Chanda Ijtema Khuddam and Lajna<br></span></td>
                <td style="width: 72.1042%;"><span style="font-size: 12px;">For a monthly salary of Rs10 000, Rs300 should be paid per <span style="color: rgb(44, 130, 201);">annum&nbsp;</span><strong>or&nbsp;</strong>Rs25 &nbsp;per<strong>&nbsp;</strong><span style="color: rgb(226, 80, 65);">month</span><br></span></td>
              </tr>
              <tr>
                <th scope="row" style="width: 6.2232%;"><span style="font-size: 12px;">6</span></th>
                <td style="width: 6.6023%;"><span style="font-size: 12px;">0.08%<br></span></td>
                <td style="width: 15.017%;"><span style="font-size: 12px;">Chanda Ijtema Ansar<br></span></td>
                <td style="width: 72.1042%;"><span style="font-size: 12px;">For a monthly salary of Rs10 000, Rs108 should be paid per <span style="color: rgb(44, 130, 201);">annum&nbsp;</span><strong>or&nbsp;</strong>Rs9 &nbsp;per<strong>&nbsp;</strong><span style="color: rgb(226, 80, 65);">month</span><br></span></td>
              </tr>
            </tbody>
          </table>
          <blockquote class="blockquote">
            <p><span style="font-size:10px;"><i>Note : Students and non-earning members are required to pay a monthly fee of&nbsp;</i></span><span style="background-color:#212121;color:rgb(250,197,28);font-size:10px;"><i>Rs 60 for Chanda Khuddam/Lajna</i></span><span style="font-size:10px;"><i> and </i></span><span style="background-color:#212121;color:rgb(250,197,28);font-size:10px;"><i>Rs 15 for Chanda Ijtama.</i></span></p>
          </blockquote>
        </div>
      </div>
    </div>

    <!-- AIMS Page -->
    <div id="aims" class="page-section">
      <div class="card">
        <div class="card-body">
          <h2 class="section-title">Settings</h2>
          <form id="settingsForm">
            <div class="form-group">
              <label for="AIMSnumber">Aims Number</label>
              <input type="number" class="form-control" id="AIMSnumber" name="number">
            </div>
            
            <div class="form-group">
              <label><strong>Member Type:</strong></label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Musis" id="musisCheckbox">
                <label class="form-check-label" for="musisCheckbox">
                  Are you a Musis? <i class="fas fa-info-circle info-icon" title="Musis members follow the Wassiyat scheme with different rates"></i>
                </label>
              </div>
            </div>
            
            <div class="form-group">
              <label for="memberGroup"><strong>Member Group:</strong></label>
              <select class="form-control" id="memberGroup" name="group" required>
                <option value="">Select Member Group</option>
                <option value="Khuddam">Khuddam</option>
                <option value="Lajna">Lajna</option>
                <option value="Non-earning Lajna">Non-earning Lajna</option>
                <option value="Ansar">Ansar</option>
                <option value="Student">Student</option>
              </select>
            </div>
            
            <div class="form-group">
              <label><strong>Date Range:</strong></label>
              <div class="row">
                <div class="col-md-6">
                  <label>From Month:</label>
                  <select class="form-control" id="fromMonth">
                    <option value="">Select Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label>From Year:</label>
                  <select class="form-control" id="fromYear"></select>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-md-6">
                  <label>To Month (Optional):</label>
                  <select class="form-control" id="toMonth">
                    <option value="">Select Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label>To Year (Optional):</label>
                  <select class="form-control" id="toYear"></select>
                </div>
              </div>
              <small class="form-text text-muted">If no date is selected, current month and year will be displayed.</small>
            </div>
            
            <br>
            <button id="saveSettings" type="submit" style="width:100%;" class="btn btn-warning">Save Settings</button>
          </form>
          <div class="container mt-4">
            <div id="errorMessages" class="mt-3 text-danger"></div>
            <div id="successMessages" class="mt-3 text-success"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden link for download -->
  <a id="imageDownload" download="Chanda_Breakdown.png"></a>

  <!-- Include Bootstrap JS and jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

  <script>
    // Initialize the application
    document.addEventListener("DOMContentLoaded", function() {
      initApp();
    });

    function initApp() {
      loadSavedData();
      initNavigation();
      initEventListeners();
      initYearDropdowns();
      checkMemberGroup();
      updateAimsDisplay();
    }

    function initNavigation() {
      const pages = ["home", "about", "privacy", "rate", "aims"];
      let defaultPage = "home";

      if (!localStorage.getItem("memberGroup")) {
        defaultPage = "aims";
      }

      function showPage(page) {
        // Hide all pages
        pages.forEach((p) => {
          const pageElement = document.getElementById(p);
          if (pageElement) {
            pageElement.classList.remove("active");
          }
        });
        
        // Show the requested page
        const activePage = document.getElementById(page);
        if (activePage) {
          activePage.classList.add("active");
        }
        
        // Update active nav link
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${page}`) {
            link.classList.add('active');
          }
        });
        
        window.location.hash = page;
        
        // Update UI based on current page
        if (page === "home") {
          checkMemberGroupForHome();
        }
      }

      // Handle initial page load
      const initialPage = window.location.hash ? window.location.hash.substr(1) : defaultPage;
      if (pages.includes(initialPage)) {
        showPage(initialPage);
      } else {
        showPage(defaultPage);
      }

      // Handle hash changes
      window.addEventListener("hashchange", function() {
        const currentPage = window.location.hash.substr(1);
        if (pages.includes(currentPage)) {
          showPage(currentPage);
          // Close mobile navbar if open
          const navbarToggler = document.getElementById("navbar");
          if (navbarToggler && !navbarToggler.classList.contains('collapsed')) {
            navbarToggler.click();
          }
        }
      });
    }

    function initYearDropdowns() {
      const currentYear = new Date().getFullYear();
      const fromYearSelect = document.getElementById("fromYear");
      const toYearSelect = document.getElementById("toYear");
      
      if (!fromYearSelect || !toYearSelect) return;
      
      fromYearSelect.innerHTML = '';
      toYearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= currentYear - 1; year--) {
        const option1 = document.createElement("option");
        option1.value = year;
        option1.textContent = year;
        fromYearSelect.appendChild(option1);
        
        const option2 = document.createElement("option");
        option2.value = year;
        option2.textContent = year;
        toYearSelect.appendChild(option2);
      }
      
      fromYearSelect.value = currentYear;
      toYearSelect.value = currentYear;
    }

    function checkMemberGroup() {
      if (!localStorage.getItem("memberGroup")) {
        showPage("aims");
      }
    }

    function checkMemberGroupForHome() {
      const savedGroup = localStorage.getItem("memberGroup");
      const salaryInput = document.getElementById("salary");
      const salaryError = document.getElementById("salaryError");
      
      if (!salaryInput || !salaryError) return;
      
      if (!savedGroup) {
        salaryInput.disabled = true;
        salaryInput.placeholder = "Please set Member Group in Settings first";
        salaryError.style.display = "block";
      } else {
        salaryInput.disabled = false;
        salaryInput.placeholder = "Enter your monthly income";
        salaryError.style.display = "none";
      }
    }

    function showPage(page) {
      const pages = ["home", "about", "privacy", "rate", "aims"];
      
      // Hide all pages
      pages.forEach((p) => {
        const pageElement = document.getElementById(p);
        if (pageElement) {
          pageElement.classList.remove("active");
        }
      });
      
      // Show the requested page
      const activePage = document.getElementById(page);
      if (activePage) {
        activePage.classList.add("active");
      }
      
      // Update active nav link
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${page}`) {
          link.classList.add('active');
        }
      });
    }

    function loadSavedData() {
      // Load AIMS number
      const aimsInput = document.getElementById("AIMSnumber");
      if (aimsInput && localStorage.getItem("AIMSnumber")) {
        aimsInput.value = localStorage.getItem("AIMSnumber");
      }
      
      // Load notes
      const notesTextarea = document.getElementById("notesTextarea");
      if (notesTextarea && localStorage.getItem("chandaNotes")) {
        notesTextarea.value = localStorage.getItem("chandaNotes");
      }
      
      // Load member type
      const musisCheckbox = document.getElementById("musisCheckbox");
      if (musisCheckbox && localStorage.getItem("isMusis") === "true") {
        musisCheckbox.checked = true;
      }
      
      // Load member group
      const memberGroupSelect = document.getElementById("memberGroup");
      if (memberGroupSelect && localStorage.getItem("memberGroup")) {
        memberGroupSelect.value = localStorage.getItem("memberGroup");
      }
      
      // Load date range
      const fromMonthSelect = document.getElementById("fromMonth");
      if (fromMonthSelect && localStorage.getItem("fromMonth")) {
        fromMonthSelect.value = localStorage.getItem("fromMonth");
      }
      
      const fromYearSelect = document.getElementById("fromYear");
      if (fromYearSelect && localStorage.getItem("fromYear")) {
        fromYearSelect.value = localStorage.getItem("fromYear");
      }
      
      const toMonthSelect = document.getElementById("toMonth");
      if (toMonthSelect && localStorage.getItem("toMonth")) {
        toMonthSelect.value = localStorage.getItem("toMonth");
      }
      
      const toYearSelect = document.getElementById("toYear");
      if (toYearSelect && localStorage.getItem("toYear")) {
        toYearSelect.value = localStorage.getItem("toYear");
      }
    }

    function initEventListeners() {
      // Member group change
      const memberGroupSelect = document.getElementById("memberGroup");
      if (memberGroupSelect) {
        memberGroupSelect.addEventListener("change", function() {
          console.log("Member group changed to:", this.value);
        });
      }
      
      // Add row button
      const addRowBtn = document.getElementById("addRowBtn");
      if (addRowBtn) {
        addRowBtn.addEventListener("click", addRow);
      }
      
      // Settings form submission
      const settingsForm = document.getElementById("settingsForm");
      if (settingsForm) {
        settingsForm.addEventListener("submit", saveSettings);
      }
      
      // Salary input
      const salaryInput = document.getElementById("salary");
      if (salaryInput) {
        salaryInput.addEventListener("input", calculate);
      }
      
      // Table input change listeners
      const tableInputs = document.querySelectorAll("#inputAam, #inputJalsa, #inputKhuddam, #inputIjtema, #inputTehrik, #inputWaqf");
      tableInputs.forEach(input => {
        input.addEventListener("input", calculate);
      });
      
      // Notes textarea
      const notesTextarea = document.getElementById("notesTextarea");
      if (notesTextarea) {
        notesTextarea.addEventListener("blur", saveNotes);
      }
      
      // Save screenshot button - NEW: Shows instructions
      const saveImageBtn = document.getElementById("saveImageBtn");
      if (saveImageBtn) {
        saveImageBtn.addEventListener("click", showInstructionModal);
      }
      
      // Share screenshot button - NEW: Shows instructions
      const shareImageBtn = document.getElementById("shareImageBtn");
      if (shareImageBtn) {
        shareImageBtn.addEventListener("click", showInstructionModal);
      }
    }

    function updateAimsDisplay() {
      const aimsDisplay = document.getElementById("aimsDisplay");
      const aimsDisplayText = document.getElementById("aimsDisplayText");
      const dateRangeDisplay = document.getElementById("dateRangeDisplay");
      
      if (!aimsDisplay || !aimsDisplayText || !dateRangeDisplay) return;
      
      const aimsNumber = localStorage.getItem("AIMSnumber");
      const fromMonth = localStorage.getItem("fromMonth");
      const fromYear = localStorage.getItem("fromYear");
      const toMonth = localStorage.getItem("toMonth");
      const toYear = localStorage.getItem("toYear");
      
      if (aimsNumber) {
        aimsDisplayText.textContent = `AIMS: ${aimsNumber}`;
        aimsDisplay.style.display = "block";
        
        let dateRangeText = '';
        if (fromMonth && fromYear) {
          if (toMonth && toYear) {
            if (fromMonth === toMonth && fromYear === toYear) {
              dateRangeText = `For: ${fromMonth} ${fromYear}`;
            } else {
              dateRangeText = `From: ${fromMonth} ${fromYear} to ${toMonth} ${toYear}`;
            }
          } else {
            dateRangeText = `For: ${fromMonth} ${fromYear}`;
          }
        } else {
          const currentDate = new Date();
          const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
          const currentYear = currentDate.getFullYear();
          dateRangeText = `For: ${currentMonth} ${currentYear}`;
        }
        
        dateRangeDisplay.textContent = dateRangeText;
      } else {
        aimsDisplay.style.display = "none";
      }
    }

    function saveNotes() {
      const notesTextarea = document.getElementById("notesTextarea");
      if (notesTextarea) {
        const notes = notesTextarea.value;
        localStorage.setItem("chandaNotes", notes);
      }
    }

    function showSuccessMessage() {
      const successMessage = document.getElementById("successMessage");
      if (successMessage) {
        successMessage.style.display = 'block';
        setTimeout(function() {
          successMessage.style.display = 'none';
        }, 5000);
      }
    }

    function showInstructionModal() {
      const instructionModal = document.getElementById("instructionModal");
      if (instructionModal) {
        instructionModal.style.display = 'block';
      }
    }

    function closeInstructionModal() {
      const instructionModal = document.getElementById("instructionModal");
      if (instructionModal) {
        instructionModal.style.display = 'none';
      }
    }

    function addRow() {
      const table = document.getElementById("myTable");
      const tableBody = document.getElementById("tableBody");
      
      if (!table || !tableBody) return;
      
      const newRow = table.insertRow(table.rows.length - 1);
      
      const fundCell = newRow.insertCell();
      const amountCell = newRow.insertCell();
      const inputCell = newRow.insertCell();
      
      const fundInput = document.createElement("input");
      fundInput.type = "text";
      fundInput.style.width = "100%";
      fundInput.placeholder = "Fund Name";
      fundInput.className = "form-control additional-fund-input";
      
      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.style.width = "75%";
      amountInput.min = "0";
      amountInput.className = "additionalField form-control additional-fund-amount";
      amountInput.value = "0";
      amountInput.addEventListener("input", calculate);
      
      fundCell.appendChild(fundInput);
      amountCell.appendChild(amountInput);
      inputCell.innerHTML = "&nbsp;";
      
      // Add event listener to the new fund input
      fundInput.addEventListener("input", function() {
        calculate();
      });
    }

    function calculate() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
      }
      
      setTimeout(() => {
        const salaryInput = document.getElementById("salary");
        const salary = salaryInput ? parseFloat(salaryInput.value) || 0 : 0;
        const isMusis = localStorage.getItem("isMusis") === "true";
        const group = localStorage.getItem("memberGroup");
        const inputAam = parseFloat(document.getElementById("inputAam")?.value) || 0;
        const inputJalsa = parseFloat(document.getElementById("inputJalsa")?.value) || 0;
        const inputKhuddam = parseFloat(document.getElementById("inputKhuddam")?.value) || 0;
        const inputIjtema = parseFloat(document.getElementById("inputIjtema")?.value) || 0;
        const inputTehrik = parseFloat(document.getElementById("inputTehrik")?.value) || 0;
        const inputWaqf = parseFloat(document.getElementById("inputWaqf")?.value) || 0;
        
        // Get additional field values
        const additionalFields = document.querySelectorAll(".additionalField");
        let totalAdditional = 0;
        additionalFields.forEach(field => {
          totalAdditional += parseFloat(field.value) || 0;
        });
        
        if (!group) {
          if (loadingSpinner) loadingSpinner.style.display = 'none';
          resetCalculationValues();
          return;
        }
        
        let aamString, groupString, aam, jalsa, khuddam, ijtema;
        
        if (group === "Student" || group === "Non-earning Lajna") {
          aamString = "Aam";
          groupString = group === "Student" ? "Student" : "Non-earning Lajna";
          aam = 0;
          jalsa = 0;
          
          if (group === "Student") {
            khuddam = 60;
            ijtema = 15;
          } else {
            khuddam = 65;
            ijtema = 30;
          }
        } else {
          aamString = isMusis ? "Wassiyat" : "Aam";
          groupString = group;
          
          if (salary === 0) {
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            resetCalculationValues();
            return;
          }
          
          if (group === "Ansar") {
            aam = isMusis ? 
              Math.ceil((10 / 100) * salary) : 
              Math.ceil((6.25 / 100) * salary);
            
            jalsa = Math.ceil((0.833 / 100) * salary);
            khuddam = Math.ceil((1 / 100) * salary);
            ijtema = Math.ceil((0.0833 / 100) * salary);
          } else {
            aam = isMusis ? 
              Math.ceil((10 / 100) * salary) : 
              Math.ceil((6.25 / 100) * salary);
            
            jalsa = Math.ceil(((10 / 100) * salary) / 12);
            khuddam = Math.ceil((1 / 100) * salary);
            ijtema = Math.ceil(((3 / 100) * salary) / 12);
          }
        }
        
        aam += inputAam;
        jalsa += inputJalsa;
        khuddam += inputKhuddam;
        ijtema += inputIjtema;
        
        const tehrikValue = inputTehrik > 0 ? inputTehrik : '-';
        const waqfValue = inputWaqf > 0 ? inputWaqf : '-';
        
        // Calculate total including additional funds
        let total = aam + jalsa + khuddam + ijtema + inputTehrik + inputWaqf + totalAdditional;
        
        // Update UI elements if they exist
        const aamStringElement = document.getElementById("aamString");
        const aamValueElement = document.getElementById("aamValue");
        const jalsaValueElement = document.getElementById("jalsaValue");
        const groupStringElement = document.getElementById("groupString");
        const khuddamValueElement = document.getElementById("khuddamValue");
        const ijtemaValueElement = document.getElementById("ijtemaValue");
        const tehrikValueElement = document.getElementById("tehrikValue");
        const waqfValueElement = document.getElementById("waqfValue");
        const totalValueElement = document.getElementById("totalValue");
        
        if (aamStringElement) aamStringElement.textContent = aamString;
        if (aamValueElement) aamValueElement.textContent = aam || '-';
        if (jalsaValueElement) jalsaValueElement.textContent = jalsa || '-';
        if (groupStringElement) groupStringElement.textContent = groupString;
        if (khuddamValueElement) khuddamValueElement.textContent = khuddam || '-';
        if (ijtemaValueElement) ijtemaValueElement.textContent = ijtema || '-';
        if (tehrikValueElement) tehrikValueElement.textContent = tehrikValue;
        if (waqfValueElement) waqfValueElement.textContent = waqfValue;
        if (totalValueElement) totalValueElement.textContent = total || '-';
        
        if (loadingSpinner) {
          loadingSpinner.style.display = 'none';
        }
      }, 100);
    }

    function resetCalculationValues() {
      const elements = {
        "aamString": "Aam",
        "aamValue": "-",
        "jalsaValue": "-",
        "groupString": "Khuddam",
        "khuddamValue": "-",
        "ijtemaValue": "-",
        "tehrikValue": "-",
        "waqfValue": "-",
        "totalValue": "-"
      };
      
      for (const [id, value] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      }
    }

    function saveSettings(event) {
      event.preventDefault();
      
      const AIMSnumber = document.getElementById("AIMSnumber")?.value;
      const isMusis = document.getElementById("musisCheckbox")?.checked;
      const memberGroup = document.getElementById("memberGroup")?.value;
      const fromMonth = document.getElementById("fromMonth")?.value;
      const fromYear = document.getElementById("fromYear")?.value;
      const toMonth = document.getElementById("toMonth")?.value;
      const toYear = document.getElementById("toYear")?.value;
      
      // Member Group is required
      if (!memberGroup) {
        alert("Please select a Member Group.");
        return;
      }
      
      // Date validation
      if (toMonth && toYear && fromMonth && fromYear) {
        const months = ["January", "February", "March", "April", "May", "June", 
                       "July", "August", "September", "October", "November", "December"];
        const fromMonthIndex = months.indexOf(fromMonth);
        const toMonthIndex = months.indexOf(toMonth);
        
        if (toYear < fromYear || (toYear === fromYear && toMonthIndex < fromMonthIndex)) {
          alert("'To' date should be after or equal to 'From' date.");
          return;
        }
      }
      
      // Save to localStorage
      if (AIMSnumber) {
        localStorage.setItem("AIMSnumber", AIMSnumber);
      } else {
        localStorage.removeItem("AIMSnumber");
      }
      
      localStorage.setItem("isMusis", isMusis);
      localStorage.setItem("memberGroup", memberGroup);
      
      // Save date values (can be empty)
      localStorage.setItem("fromMonth", fromMonth || "");
      localStorage.setItem("fromYear", fromYear || "");
      localStorage.setItem("toMonth", toMonth || "");
      localStorage.setItem("toYear", toYear || "");
      
      updateAimsDisplay();
      showSuccessMessage();
      showPage("home");
      checkMemberGroupForHome();
      
      const salary = document.getElementById("salary")?.value;
      if (salary) {
        calculate();
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const instructionModal = document.getElementById("instructionModal");
      if (event.target == instructionModal) {
        instructionModal.style.display = "none";
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeInstructionModal();
      }
    });
  </script>
</body>
<footer class="footer mt-auto py-3 bg-dark">
  <div class="container">
    <p><span style="color: #ffc107;">Contact : <span style="color: #ffffff;"><a style="color: #ffffff;" title="Contact " href="mailto:darussalaamoffice@gmail.com" target="_blank">darussalaamoffice@gmail.com</a></span></span></p>
  </div>
</footer>
</html>
